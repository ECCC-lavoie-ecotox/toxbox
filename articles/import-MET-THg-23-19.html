<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Importation des résultats de laboratoire MET-THg-23-19 • toxbox</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Importation des résultats de laboratoire MET-THg-23-19">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">toxbox</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/censored_value.html">Fonctions pour traiter les valeurs censurées dans les bases de données de contaminants</a>
    </li>
    <li>
      <a href="../articles/import-MET-THg-23-19.html">Importation des résultats de laboratoire MET-THg-23-19</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ECCC-lavoie-ecotox/toxbox/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Importation des résultats de laboratoire
MET-THg-23-19</h1>
                        <h4 data-toc-skip class="author">Steve
Vissault</h4>
            
            <h4 data-toc-skip class="date">2024-08-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ECCC-lavoie-ecotox/toxbox/blob/master/vignettes/articles/import-MET-THg-23-19.Rmd" class="external-link"><code>vignettes/articles/import-MET-THg-23-19.Rmd</code></a></small>
      <div class="hidden name"><code>import-MET-THg-23-19.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html" class="external-link">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>eval <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Ce document permet d’importer les mesures de laboratoire pour le
rapport MET-Thg-23-19</p>
<div class="section level2">
<h2 id="faire-une-sauvegarde-de-la-base-de-données">Faire une sauvegarde de la base de données<a class="anchor" aria-label="anchor" href="#faire-une-sauvegarde-de-la-base-de-donn%C3%A9es"></a>
</h2>
<p>Première étape, on veut être en mesure de restaurer la base de
données si l’importation introduit des erreurs dans la base de
données.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">db_path</span> <span class="op">&lt;-</span> <span class="st">"Z:/07-Données BD/Database/contaminants-rlavoie-eccc.sqlite"</span></span>
<span></span>
<span><span class="va">db_bak</span> <span class="op">&lt;-</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html" class="external-link">str_replace</a></span><span class="op">(</span></span>
<span>    <span class="va">db_path</span>, </span>
<span>    pattern <span class="op">=</span> <span class="st">".sqlite"</span>, </span>
<span>    replacement <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"-{format(Sys.Date(), '%Y%m%d')}.bak.sqlite"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.copy</a></span><span class="op">(</span><span class="va">db_path</span>, <span class="va">db_bak</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="chargements-des-résultats-du-laboratoire">Chargements des résultats du laboratoire<a class="anchor" aria-label="anchor" href="#chargements-des-r%C3%A9sultats-du-laboratoire"></a>
</h2>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lab_results_file</span> <span class="op">&lt;-</span> <span class="st">"Z:/03-Labo/Results Reports/À entrer dans la BD/MET-THg-23-19 - RALA01-2023.xlsx"</span></span>
<span></span>
<span><span class="co"># Informations sur les échantillons</span></span>
<span><span class="va">sampleInfoLab</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html" class="external-link">read_xlsx</a></span><span class="op">(</span><span class="va">lab_results_file</span>, <span class="st">"SampleInfo"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Informations sur les mesures</span></span>
<span><span class="va">measurementsLab</span> <span class="op">&lt;-</span> <span class="fu">readxl</span><span class="fu">::</span><span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html" class="external-link">read_xlsx</a></span><span class="op">(</span><span class="va">lab_results_file</span>, <span class="st">"SampleData"</span><span class="op">)</span> </span></code></pre></div>
</div>
<div class="section level2">
<h2 id="connection-à-la-base-de-données">Connection à la base de données<a class="anchor" aria-label="anchor" href="#connection-%C3%A0-la-base-de-donn%C3%A9es"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">toxbox</span><span class="fu">::</span><span class="fu"><a href="../reference/init_con.html">init_con</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="injection-des-métadonnées-sur-le-rapport-et-le-projet">Injection des métadonnées sur le rapport et le projet<a class="anchor" aria-label="anchor" href="#injection-des-m%C3%A9tadonn%C3%A9es-sur-le-rapport-et-le-projet"></a>
</h2>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">report</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    id_report <span class="op">=</span> <span class="st">"MET-Thg-23-19"</span>,</span>
<span>    id_project <span class="op">=</span> <span class="st">"RALA01-2023"</span>,</span>
<span>    report_date <span class="op">=</span> <span class="st">"2024-07-31"</span>,</span>
<span>    report_access_path <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html" class="external-link">str_replace</a></span><span class="op">(</span><span class="st">"Z:/03-Labo/Results Reports/À entrer dans la BD/MET-THg-23-19 - RALA01-2023.xlsx"</span>, <span class="st">"À entrer dans la BD"</span>, <span class="st">"Saisie dans la BD"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>On valide si le projet existe déjà dans la base de données</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">toxbox</span><span class="fu">::</span><span class="fu"><a href="../reference/search_tbl.html">search_tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"project"</span>, id_project <span class="op">=</span> <span class="st">"RALA01-2023"</span><span class="op">)</span></span></code></pre></div>
<p>Il existe déjà dans la base de données. On peut donc importer les
métadonnées du rapport qui seront attaché à ce projet.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html" class="external-link">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"report"</span>, <span class="va">report</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="préparation-des-données-sur-les-échantillons">Préparation des données sur les échantillons<a class="anchor" aria-label="anchor" href="#pr%C3%A9paration-des-donn%C3%A9es-sur-les-%C3%A9chantillons"></a>
</h2>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">field_sample</span> <span class="op">&lt;-</span> <span class="va">sampleInfoLab</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    id_lab_sample <span class="op">=</span> <span class="va">SampleID</span>,</span>
<span>    id_field_sample <span class="op">=</span> <span class="va">ClientID</span>,</span>
<span>    collection_date <span class="op">=</span> <span class="va">CollectionDate</span>,</span>
<span>    id_site <span class="op">=</span> <span class="va">Location</span>,</span>
<span>    id_species <span class="op">=</span> <span class="va">Species</span>,</span>
<span>    tissue <span class="op">=</span> <span class="va">Tissue</span>,</span>
<span>    age <span class="op">=</span> <span class="va">Age</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="préparation-des-données-sur-les-mesures">Préparation des données sur les mesures<a class="anchor" aria-label="anchor" href="#pr%C3%A9paration-des-donn%C3%A9es-sur-les-mesures"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">measurements</span> <span class="op">&lt;-</span> <span class="va">measurementsLab</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>    id_lab_sample <span class="op">=</span> <span class="va">SampleID</span>,</span>
<span>    id_field_sample <span class="op">=</span> <span class="va">ClientID</span>,</span>
<span>    pmoisture <span class="op">=</span> <span class="va">`% Moisture`</span>,</span>
<span>    value <span class="op">=</span> <span class="va">`Total Mercury (µg/g (dry))`</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    id_analyte <span class="op">=</span> <span class="st">"thg_dw"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="établir-la-correspondance-avec-les-sites-existants">Établir la correspondance avec les sites existants<a class="anchor" aria-label="anchor" href="#%C3%A9tablir-la-correspondance-avec-les-sites-existants"></a>
</h2>
<p>On valide si le ou les site(s) de collecte des échantillons existent
dans la base de données</p>
<p>On isole dans un premier temps les sites présent dans les résultats
envoyés par le laboratoire.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">sitesLab</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">sampleInfoLab</span>, <span class="va">Location</span>, <span class="va">Latitude</span>, <span class="va">Longitude</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>On recherche dans la base de données les sites à l’aide de mots
clés.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">betchouanes_site_db</span> <span class="op">&lt;-</span> <span class="fu">toxbox</span><span class="fu">::</span><span class="fu"><a href="../reference/search_tbl.html">search_tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"sites"</span>, id_site <span class="op">=</span> <span class="st">"%betchouanes%"</span><span class="op">)</span></span>
<span><span class="va">mingan_site_db</span> <span class="op">&lt;-</span> <span class="fu">toxbox</span><span class="fu">::</span><span class="fu"><a href="../reference/search_tbl.html">search_tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"sites"</span>, id_site <span class="op">=</span> <span class="st">"%mingan%"</span><span class="op">)</span></span></code></pre></div>
<p>Après avoir chercher les sites dans la base de données, nous pouvons
nous apercevoir que le site de betchouanes est déjà renseigné dans la
base de données mais pas le site de Longue-Pointe-de-Mingan. On ajoute
donc ce site.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">add_site</span> <span class="op">&lt;-</span> <span class="va">sitesLab</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Location</span> <span class="op">==</span> <span class="st">"Longue-Pointe-de-Mingan"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span></span>
<span>        id_site <span class="op">=</span> <span class="va">Location</span>,</span>
<span>        lat <span class="op">=</span> <span class="va">Latitude</span>,</span>
<span>        lon <span class="op">=</span> <span class="va">Longitude</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        province <span class="op">=</span> <span class="st">'Québec'</span>,</span>
<span>        srid <span class="op">=</span> <span class="fl">4326</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html" class="external-link">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"sites"</span>, <span class="va">add_site</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>On vérifie que le site a bel et bien été ajouté dans la base de
données.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">toxbox</span><span class="fu">::</span><span class="fu"><a href="../reference/search_tbl.html">search_tbl</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"sites"</span>, id_site <span class="op">=</span> <span class="st">"Longue-Pointe-de-Mingan"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">field_sample</span> <span class="op">&lt;-</span> <span class="va">field_sample</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        id_site <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>            <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">id_site</span>, <span class="st">"Ile a Calculot des Betchouanes"</span><span class="op">)</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">betchouanes_site_db</span><span class="op">$</span><span class="va">id_site</span>,</span>
<span>            .default <span class="op">=</span> <span class="va">id_site</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="établir-la-correspondance-avec-les-espèces-présentes-dans-la-base-de-données">Établir la correspondance avec les espèces présentes dans la base de
données<a class="anchor" aria-label="anchor" href="#%C3%A9tablir-la-correspondance-avec-les-esp%C3%A8ces-pr%C3%A9sentes-dans-la-base-de-donn%C3%A9es"></a>
</h2>
<p>On liste les espèces en premier les espèces présente dans les
résultats de laboratoire.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">field_sample</span><span class="op">$</span><span class="va">id_species</span><span class="op">)</span></span></code></pre></div>
<p>On compare avec la liste des espèces présentes dans la base de
données.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbReadTable.html" class="external-link">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"species"</span><span class="op">)</span></span></code></pre></div>
<p>On créé un tableau avec les espèces qui ne sont pas présentes dans la
base de données.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_species</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>   <span class="op">~</span><span class="va">org_species</span>, <span class="op">~</span><span class="va">id_species</span>, <span class="op">~</span><span class="va">organism</span>, <span class="op">~</span><span class="va">genus</span>, <span class="op">~</span><span class="va">species</span>, <span class="op">~</span><span class="va">vernacular_fr</span>, <span class="op">~</span><span class="va">vernacular_en</span>,</span>
<span>  <span class="st">"Alose sp."</span>, <span class="st">"SHSP"</span>, <span class="st">"Fish"</span>, <span class="st">"Alosa"</span>,   <span class="st">"Alosa sp."</span>, <span class="st">"Alose"</span>, <span class="st">"Shad"</span>,</span>
<span>  <span class="st">"Gadidae sp."</span>, <span class="st">"COSP"</span>, <span class="st">"Fish"</span>, <span class="st">"Gadidae"</span>, <span class="st">"Gadidae sp."</span>, <span class="st">"Morue"</span>, <span class="st">"Cod"</span>,</span>
<span>  <span class="st">"Lompenie tachete"</span>, <span class="st">"DASH"</span>, <span class="st">"Fish"</span>, <span class="st">"Gadidae"</span>, <span class="st">"Leptoclinus maculatus"</span>, <span class="st">"Lompénie tachetée"</span>, <span class="st">"Daubed shanny"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>On ajoute ces espèces dans la base de données</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html" class="external-link">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"species"</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">new_species</span>, <span class="op">-</span><span class="va">org_species</span><span class="op">)</span></span>
<span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>On valide visuellement que les nouvelles espèces se retrouvent bien
dans la base de données</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbReadTable.html" class="external-link">dbReadTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"species"</span><span class="op">)</span></span></code></pre></div>
<p>On effectue la correspondance entre les codes espèces du rapport de
laboratoire et ceux de la base de données.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">field_sample</span> <span class="op">&lt;-</span> <span class="va">field_sample</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    id_species <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">id_species</span> <span class="op">==</span> <span class="st">"Alose sp."</span> <span class="op">~</span> <span class="st">"SHSP"</span>,</span>
<span>        <span class="va">id_species</span> <span class="op">==</span> <span class="st">"Capelan"</span> <span class="op">~</span> <span class="st">"CAPE"</span>,</span>
<span>        <span class="va">id_species</span> <span class="op">==</span> <span class="st">"Gadidae sp."</span> <span class="op">~</span> <span class="st">"COSP"</span>,</span>
<span>        <span class="va">id_species</span> <span class="op">==</span> <span class="st">"Lancon"</span> <span class="op">~</span> <span class="st">"SAND"</span>,</span>
<span>        <span class="va">id_species</span> <span class="op">==</span> <span class="st">"Lompenie tachete"</span> <span class="op">~</span> <span class="st">"DASH"</span>,</span>
<span>        .default <span class="op">=</span> <span class="cn">NA</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">id_species</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="injection-des-mesures-du-laboratoire">Injection des mesures du laboratoire<a class="anchor" aria-label="anchor" href="#injection-des-mesures-du-laboratoire"></a>
</h2>
<p>Les étapes précédentes ont permis de mettre à jour les tables de
références pour les sites et les espèces.</p>
<p>On peut maintenant procéder à importer les données sur les
échantillons et les mesures.</p>
<div class="section level3">
<h3 id="field-samples">Field samples<a class="anchor" aria-label="anchor" href="#field-samples"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">field_sample</span>, <span class="va">id_field_sample</span>, <span class="va">collection_date</span>, <span class="va">id_site</span>, <span class="va">id_species</span>, <span class="va">age</span>, <span class="va">tissue</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="op">(</span>\<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html" class="external-link">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"field_sample"</span>, <span class="va">data</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="lab-samples">Lab samples<a class="anchor" aria-label="anchor" href="#lab-samples"></a>
</h3>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">field_sample</span>, <span class="va">id_lab_sample</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="op">(</span>\<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html" class="external-link">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"lab_sample"</span>, <span class="va">data</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="lab-field-samples">Lab field samples<a class="anchor" aria-label="anchor" href="#lab-field-samples"></a>
</h3>
<p>Cette table effectue la liaison entre les échantillons de laboratoire
et les échantillons de terrain.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">field_sample</span>, <span class="va">id_lab_sample</span>, <span class="va">id_field_sample</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="op">(</span>\<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html" class="external-link">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"lab_field_sample"</span>, <span class="va">data</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="lab-measurements">Lab measurements<a class="anchor" aria-label="anchor" href="#lab-measurements"></a>
</h3>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set method detection limit</span></span>
<span><span class="va">MDL</span> <span class="op">&lt;-</span> <span class="fl">0.0001</span></span>
<span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">measurements</span>, <span class="va">id_lab_sample</span>, <span class="va">id_analyte</span>, <span class="va">value</span>, percent_moisture <span class="op">=</span> <span class="va">pmoisture</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>is_censored <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">value</span> <span class="op">&gt;</span> <span class="va">MDL</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id_report <span class="op">=</span> <span class="va">report</span><span class="op">$</span><span class="va">id_report</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="op">(</span>\<span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWriteTable.html" class="external-link">dbWriteTable</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"lab_measurement"</span>, <span class="va">data</span>, append <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Steve Vissault, Anais Kerric, Rose Lacombe, Raphael Lavoie.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
